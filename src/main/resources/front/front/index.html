<!-- 首页 -->
<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<title>城市公交查询系统 - 首页</title>
		<link rel="stylesheet" href="./layui/css/layui.css">
		<link rel="stylesheet" href="./xznstatic/css/common.css"/>
		<link rel="stylesheet" href="./xznstatic/css/style.css"/>
		<link rel="stylesheet" href="./css/accessibility-sr-only.css">
		<link rel="stylesheet" href="./css/accessibility-high-contrast.css">
		<link rel="stylesheet" href="./css/transit-business-ui.css">
	</head>
	<style type="text/css">
		html, body {
			height: 100%;
		}

			#header {
				position: sticky;
				top: 0;
				width: 100%;
				z-index: 20;
			}

		#iframe {
			width: 100%;
			border: 0;
		}
	</style>
		<body class="transit-ui transit-shell" data-shell-scroll-mode="iframe">
		<!-- 跳过导航链接（无障碍） -->
		<a href="#main-content" class="skip-link">跳转到主要内容</a>
		<!-- start 顶部导航栏 -->
			<div id="header">
				<div v-if='true' class="nav-top">
				  <div v-if="true" class="nav-top-title">{{projectName}}</div>
				  <div class="nav-top-tel"></div>
				</div>
		    <div class="navs nav-reframed" role="navigation" aria-label="无障碍任务导航">
				<div class="title" v-if="false" v-text="projectName"></div>
				<div class="list nav-grid">
					<div class="nav-primary-group" aria-label="核心出行任务">
						<div class="nav-group-title">核心出行任务</div>
						<ul>
							<li :class="{current: activeNavUrl === './pages/home/home.html'}">
								<a href="javascript:void(0)" @click="openNav('./pages/home/home.html')">首页总览</a>
							</li>
							<li v-for="(item,index) in primaryNav" :key="'primary-'+index" :class="{current: activeNavUrl === item.url}">
								<a href="javascript:void(0)" @click="openNav(item.url)">{{item.name}}</a>
							</li>
						</ul>
					</div>
					<div class="nav-support-group" aria-label="服务与支持">
						<div class="nav-group-title">支持与管理</div>
						<div class="nav-utility-actions">
							<a href="javascript:void(0)" class="utility-link" @click="centerPageShell()">个人中心</a>
							<a href="javascript:void(0)" class="utility-link" @click="openAccessibilityPage()">无障碍设置</a>
							<a v-if="chatFlag" href="javascript:void(0)" class="utility-link urgent" @click="chatTapShell()">在线提问</a>
							<a v-if="showAdminEntry" :href="adminurl" target="_blank" class="utility-link">后台管理</a>
						</div>
						<div class="nav-support-links">
							<a v-for="(item,index) in supportNav" :key="'support-'+index" href="javascript:void(0)" @click="openNav(item.url)" class="support-link">{{item.name}}</a>
						</div>
					</div>
				</div>
		    </div>
			<div class="transit-assist-strip" role="region" aria-label="无障碍快捷控制区">
				<div class="assist-left">
					<div class="assist-label">Accessibility Command Deck</div>
					<div class="assist-title">无障碍快捷控制</div>
				</div>
				<div class="assist-actions">
					<button id="assistHighContrast" class="assist-btn" type="button" aria-label="切换高对比度模式">高对比度</button>
					<button id="assistFontPlus" class="assist-btn" type="button" aria-label="增大字体">字体 +</button>
					<button id="assistFontMinus" class="assist-btn" type="button" aria-label="减小字体">字体 -</button>
					<button id="assistSpeech" class="assist-btn" type="button" aria-label="切换语音播报">语音播报</button>
					<button id="assistKeyboard" class="assist-btn" type="button" aria-label="切换键盘导航">键盘导航</button>
					<span id="assistStatusText" class="assist-status" aria-live="polite">系统状态同步中…</span>
				</div>
			</div>
								</div>
		<!-- end 顶部导航栏 -->
			<main id="main-content" tabindex="-1" aria-label="页面主要内容区域">
				<iframe src="./pages/home/home.html" id="iframe" frameborder="0" scrolling="auto" width="100%" title="业务内容区域" onload="changeFrameHeight()"></iframe>
		</main>
		<button class="assist-entry-btn" type="button" aria-label="打开无障碍设置页面" onclick="navPage('./pages/accessibility/settings.html')">
			<span class="assist-entry-icon" aria-hidden="true">♿</span>
			<span>无障碍设置</span>
		</button>

		<script src="./xznstatic/js/jquery-1.11.3.min.js"></script>
		<script src="./layui/layui.js"></script>
		<script src="./js/vue.js"></script>
		<script src="./js/config.js"></script>
		<script src="./js/accessibility.js"></script>

			<script>
				var DEFAULT_IFRAME_URL = './pages/home/home.html';
				var frameResizeTimer = null;

				function normalizeIframeUrl(rawUrl) {
					var fallbackUrl = DEFAULT_IFRAME_URL;
					var url = (rawUrl || '').trim();
					if (!url) return fallbackUrl;
					if (url === 'null' || url === 'undefined') return fallbackUrl;
					if (url.indexOf('javascript:') === 0) return fallbackUrl;
					if (url.indexOf('data:') === 0) return fallbackUrl;
					if (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) return fallbackUrl;
					if (url.indexOf('//') === 0) return fallbackUrl;
					var safePathPattern = /^\.\/pages\/[a-zA-Z0-9_\-/]+\.html(?:[?#].*)?$/;
					return safePathPattern.test(url) ? url : fallbackUrl;
				}

				function applyIframeUrl(url, persist) {
					var iframe = document.getElementById('iframe');
					if (!iframe) return;
					var safeUrl = normalizeIframeUrl(url);
					if (persist !== false) {
						localStorage.setItem('iframeUrl', safeUrl);
					}
					if (vue) {
						vue.activeNavUrl = safeUrl;
					}
					var currentSrc = iframe.getAttribute('src') || '';
					if (currentSrc === safeUrl) {
						scheduleFrameResize(30);
						return;
					}
					iframe.src = safeUrl;
					scheduleFrameResize(120);
				}

	      var vue1 = new Vue({el: '#tabbar'})

			var vue = new Vue({
				el: '#header',
				data: {
					iconArr: ['layui-icon-gift','layui-icon-email','layui-icon-logout','layui-icon-transfer','layui-icon-slider','layui-icon-print','layui-icon-cols','layui-icon-snowflake','layui-icon-note','layui-icon-flag','layui-icon-theme','layui-icon-website','layui-icon-console','layui-icon-face-surprised','layui-icon-template-1','layui-icon-app','layui-icon-read','layui-icon-component','layui-icon-file-b','layui-icon-unlink','layui-icon-tabs','layui-icon-form','layui-icon-chat'],
					indexNav: indexNav,
					primaryNav: [],
					supportNav: [],
					activeNavUrl: './pages/home/home.html',
					showAdminEntry: false,
					cartFlag: cartFlag,
					adminurl: adminurl,
					chatFlag: chatFlag,
					projectName: projectName,
				},
				mounted: function() {
					this.initNavStructure();
				},
				created() {
					this.iconArr.sort(()=>{
					  return (0.5-Math.random())
					})
				},
				methods: {
					jump(url) {
						jump(url)
					},
						initNavStructure() {
							var saved = normalizeIframeUrl(localStorage.getItem('iframeUrl'));
							var role = localStorage.getItem('userTable');
							this.showAdminEntry = role === 'users';
							this.activeNavUrl = saved || DEFAULT_IFRAME_URL;
							localStorage.setItem('iframeUrl', this.activeNavUrl);
							this.primaryNav = [];
							this.supportNav = [];
						for (var i = 0; i < this.indexNav.length; i++) {
							var item = this.indexNav[i];
							if (item.name.indexOf('友情链接') !== -1 || item.name.indexOf('资源') !== -1) {
								this.supportNav.push(item);
							} else {
								this.primaryNav.push(item);
							}
						}
					},
					openNav(url) {
						this.activeNavUrl = url;
						navPage(url);
					},
					centerPageShell() {
						centerPage();
					},
					openAccessibilityPage() {
						this.openNav('./pages/accessibility/settings.html');
					},
					chatTapShell() {
						chatTap();
					}
				}
			});

					layui.use(['element','layer'], function() {
						var element = layui.element;
						var layer = layui.layer;
					});

			function chatTap(){
				var userTable = localStorage.getItem('userTable');
				if (userTable) {
					layui.layer.open({
						type: 2,
						title: '在线提问',
						area: ['600px', '600px'],
						content: './pages/chat/chat.html'
					});
				} else {
					window.location.href = './pages/login/login.html'
				}
			}

				function updateAssistStatus() {
					if (!window.AccessibilityUtils) return;
					var settings = window.AccessibilityUtils.getSettings();
					var status = [
						settings.highContrast ? '高对比开启' : '高对比关闭',
						'字体' + settings.fontSize + 'px',
						settings.speech ? '语音开启' : '语音关闭',
						settings.keyboardNav ? '键盘导航开启' : '键盘导航关闭'
					].join(' | ');
					var statusNode = document.getElementById('assistStatusText');
					if (statusNode) {
						statusNode.textContent = status;
					}
				}

			function syncAssistSettingsToIframe() {
				if (!window.AccessibilityUtils) return;
				var iframe = document.getElementById('iframe');
				if (!iframe || !iframe.contentWindow || !iframe.contentWindow.AccessibilityUtils) return;
				try {
					iframe.contentWindow.AccessibilityUtils.saveSettings(AccessibilityUtils.getSettings());
				} catch (e) {
					console.warn('同步无障碍设置到iframe失败:', e);
				}
			}

			function initAssistDeck() {
				if (!window.AccessibilityUtils) return;
				var bind = function(id, handler) {
					var node = document.getElementById(id);
					if (node) node.addEventListener('click', handler);
				};

				bind('assistHighContrast', function() {
					var enabled = AccessibilityUtils.toggleHighContrast();
					AccessibilityUtils.announce(enabled ? '高对比模式已开启' : '高对比模式已关闭');
					syncAssistSettingsToIframe();
					updateAssistStatus();
				});
				bind('assistFontPlus', function() {
					AccessibilityUtils.increaseFontSize();
					AccessibilityUtils.announce('字体已放大');
					syncAssistSettingsToIframe();
					updateAssistStatus();
				});
				bind('assistFontMinus', function() {
					AccessibilityUtils.decreaseFontSize();
					AccessibilityUtils.announce('字体已缩小');
					syncAssistSettingsToIframe();
					updateAssistStatus();
				});
				bind('assistSpeech', function() {
					var enabled = AccessibilityUtils.toggleSpeech();
					AccessibilityUtils.announce(enabled ? '语音播报已开启' : '语音播报已关闭');
					syncAssistSettingsToIframe();
					updateAssistStatus();
				});
				bind('assistKeyboard', function() {
					var enabled = AccessibilityUtils.toggleKeyboardNav();
					AccessibilityUtils.announce(enabled ? '键盘导航已开启' : '键盘导航已关闭');
					syncAssistSettingsToIframe();
					updateAssistStatus();
				});
						var iframe = document.getElementById('iframe');
						if (iframe) {
							iframe.addEventListener('load', function() {
								syncAssistSettingsToIframe();
								updateAssistStatus();
								scheduleFrameResize(0);
								scheduleFrameResize(300);
								scheduleFrameResize(1000);
							});
							iframe.addEventListener('error', function() {
								var statusNode = document.getElementById('assistStatusText');
								if (statusNode) {
									statusNode.textContent = '页面加载失败，已回退首页';
								}
								applyIframeUrl(DEFAULT_IFRAME_URL, true);
							});
						}
					syncAssistSettingsToIframe();
					updateAssistStatus();
				}

				// 导航栏跳转
					function navPage(url) {
						applyIframeUrl(url, true);
					}

			// 跳转到个人中心也
				function centerPage() {
					var userTable = localStorage.getItem('userTable');
					if (userTable) {
						var centerUrl = './pages/' + userTable + '/center.html';
						applyIframeUrl(centerUrl, true);
						} else {
							window.location.href = './pages/login/login.html'
						}
					}

						var iframeUrl = normalizeIframeUrl(localStorage.getItem('iframeUrl'));
						applyIframeUrl(iframeUrl, true);
						function scheduleFrameResize(delay) {
							clearTimeout(frameResizeTimer);
							frameResizeTimer = setTimeout(changeFrameHeight, delay || 30);
						}

						function syncShellOffset() {
							var header = document.getElementById('header');
							var main = document.getElementById('main-content');
							if (!header || !main) return;
							var computed = window.getComputedStyle(header);
							if (computed && computed.position === 'fixed') {
								main.style.paddingTop = (header.offsetHeight + 10) + 'px';
							} else {
								main.style.paddingTop = '';
							}
						}

					// 低频兜底，避免极端场景下窗口尺寸感知延迟
					setInterval(function(){
						scheduleFrameResize(0);
					}, 10000);

	      function changeFrameHeight() {
	        var iframe = document.getElementById('iframe');
	        if (!iframe) return;
	        var main = document.getElementById('main-content');
	        var header = document.getElementById('header');
	        var viewportHeight = window.innerHeight || document.documentElement.clientHeight || 900;
	        var headerHeight = header ? Math.ceil(header.getBoundingClientRect().height || header.offsetHeight || 0) : 0;
	        var mainStyle = main ? window.getComputedStyle(main) : null;
	        var padTop = mainStyle ? parseFloat(mainStyle.paddingTop || '0') : 0;
	        var padBottom = mainStyle ? parseFloat(mainStyle.paddingBottom || '0') : 0;
	        var availableHeight = Math.max(420, Math.floor(viewportHeight - headerHeight - padTop - padBottom - 2));

	        iframe.style.height = availableHeight + 'px';
	        iframe.style.overflow = 'auto';
	        iframe.setAttribute('scrolling', 'auto');

	        // 单滚动策略：外层壳页面不滚动，滚动权交给 iframe 内页
	        document.body.style.overflow = 'hidden';
	        document.documentElement.style.overflow = 'hidden';
	      };

			//  窗口变化时候iframe自适应
			// function changeFrameHeight() {
				// var header = document.getElementById('header').scrollHeight;
    //     let isshow = false
    //     var tabbar = 0
    //     if(isshow) {
    //       tabbar = document.getElementById('tabbar').scrollHeight
    //     }
				// var ifm = document.getElementById("iframe");
				// ifm.height = document.documentElement.clientHeight - header - tabbar;
				// ifm.width = document.documentElement.clientWidth;
			// }

				// reasize 事件 窗口大小变化后执行的方法
						window.onresize = function() {
							syncShellOffset();
							scheduleFrameResize(30);
						}

					setTimeout(initAssistDeck, 300);
					syncShellOffset();
					scheduleFrameResize(300);
			</script>
		</body>
	</html>
