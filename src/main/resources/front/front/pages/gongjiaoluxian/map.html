<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬äº¤è·¯çº¿åœ°å›¾</title>
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <link rel="stylesheet" href="../../xznstatic/css/common.css"/>
    <link rel="stylesheet" href="../../xznstatic/css/style.css"/>
    <script type="text/javascript" src="../../xznstatic/js/jquery-1.11.3.min.js"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #app {
            min-height: 100%;
            background: #f5f5f5;
        }

        .map-container {
            display: flex;
            padding: 20px;
            gap: 20px;
            background: #f5f5f5;
        }

        .sidebar {
            width: 320px;
            flex-shrink: 0;
        }

        .sidebar-panel {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #4d4f36;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #B7BA6B;
        }

        .route-select {
            width: 100%;
            height: 40px;
            border: 2px solid #4d4f36;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
            color: #333;
            outline: none;
        }

        .route-select:focus {
            border-color: #B7BA6B;
        }

        .route-info {
            font-size: 14px;
            color: #666;
            line-height: 1.8;
        }

        .route-info p {
            margin: 5px 0;
        }

        .route-info strong {
            color: #4d4f36;
        }

        .station-list {
            max-height: 250px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 8px;
        }

        .station-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .station-item:hover {
            background: #e9ecef;
        }

        .station-item.active {
            background: #B7BA6B;
            color: #fff;
        }

        .station-index {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background: #4d4f36;
            color: #fff;
            border-radius: 50%;
            font-size: 12px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .station-item:first-child .station-index,
        .station-item:last-child .station-index {
            background: #B7BA6B;
        }

        .map-wrapper {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #map {
            width: 100%;
            height: 600px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
        }

        .legend-color {
            width: 30px;
            height: 4px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-map {
            flex: 1;
            height: 38px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4d4f36;
            color: #fff;
        }

        .btn-primary:hover {
            background: #3a3c28;
        }

        .btn-secondary {
            background: #B7BA6B;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9a9d5a;
        }

        .btn-danger {
            background: #d94f4f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c43c3c;
        }

        /* Leaflet popup style */
        .leaflet-popup-content-wrapper {
            border-radius: 4px;
        }

        .popup-content {
            font-size: 13px;
            min-width: 120px;
        }

        .popup-content strong {
            color: #4d4f36;
        }

        /* Scrollbar style */
        .station-list::-webkit-scrollbar {
            width: 6px;
        }

        .station-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .station-list::-webkit-scrollbar-thumb {
            background: #B7BA6B;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="map-container">
            <!-- å·¦ä¾§è¾¹æ  -->
            <div class="sidebar">
                <!-- è·¯çº¿é€‰æ‹© -->
                <div class="sidebar-panel">
                    <div class="panel-title">é€‰æ‹©è·¯çº¿</div>
                    <select id="routeSelect" class="route-select" onchange="loadRoute()">
                        <option value="">-- è¯·é€‰æ‹©è·¯çº¿ --</option>
                    </select>
                </div>

                <!-- è·¯çº¿ä¿¡æ¯ -->
                <div class="sidebar-panel">
                    <div class="panel-title">è·¯çº¿ä¿¡æ¯</div>
                    <div id="routeInfo" class="route-info">
                        <p style="color: #999; text-align: center; padding: 20px 0;">è¯·é€‰æ‹©ä¸€æ¡è·¯çº¿æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                </div>

                <!-- ç«™ç‚¹åˆ—è¡¨ -->
                <div class="sidebar-panel">
                    <div class="panel-title">ç«™ç‚¹åˆ—è¡¨</div>
                    <div id="stationList" class="station-list">
                        <p style="color: #999; text-align: center; padding: 20px 0;">åŠ è½½è·¯çº¿åæ˜¾ç¤ºç«™ç‚¹</p>
                    </div>
                </div>

                <!-- å›¾ä¾‹ -->
                <div class="sidebar-panel">
                    <div class="panel-title">å›¾ä¾‹</div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196F3;"></div>
                            <span>å…¬äº¤çº¿è·¯</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #4CAF50;"></div>
                            <span>ç«™ç‚¹</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #F44336;"></div>
                            <span>è½¦è¾†</span>
                        </div>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="sidebar-panel">
                    <div class="panel-title">åœ°å›¾æ§åˆ¶</div>
                    <div class="btn-group">
                        <button class="btn-map btn-primary" onclick="fitBounds()">
                            é€‚åº”è§†å›¾
                        </button>
                        <button class="btn-map btn-secondary" id="vehicleBtn" onclick="toggleVehicle()">
                            æ¨¡æ‹Ÿè½¦è¾†
                        </button>
                    </div>
                </div>
            </div>

            <!-- åœ°å›¾å®¹å™¨ -->
            <div class="map-wrapper">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="../../layui/layui.js"></script>
    <script src="../../js/vue.js"></script>
    <script src="../../js/config.js"></script>
    <script src="../../js/utils.js"></script>

    <script>
        var map = null;
        var routeLayer = null;
        var markersLayer = null;
        var vehicleMarker = null;
        var vehicleTimer = null;
        var currentRoute = null;
        var stationData = [];
        var vehicleIndex = 0;
        var isVehicleRunning = false;
        var baseURL = 'http://localhost:8080/springbootmf383';

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = L.map('map').setView([31.2304, 121.4737], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            routeLayer = L.layerGroup().addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            loadRoutes();
        }

        // åŠ è½½è·¯çº¿åˆ—è¡¨
        function loadRoutes() {
            $.ajax({
                url: baseURL + '/map/routes',
                type: 'GET',
                success: function(res) {
                    if (res.code === 0) {
                        var select = $('#routeSelect');
                        select.empty();
                        select.append('<option value="">-- è¯·é€‰æ‹©è·¯çº¿ --</option>');
                        res.data.forEach(function(route) {
                            select.append('<option value="' + route.id + '">' +
                                route.luxianbianhao + ' - ' + route.luxianmingcheng + '</option>');
                        });

                        // è·å–URLå‚æ•°ä¸­çš„è·¯çº¿ID
                        var urlParams = new URLSearchParams(window.location.search);
                        var routeId = urlParams.get('id');
                        if (routeId) {
                            $('#routeSelect').val(routeId);
                            loadRoute();
                        }
                    }
                }
            });
        }

        // åŠ è½½è·¯çº¿
        function loadRoute() {
            var routeId = $('#routeSelect').val();
            if (!routeId) {
                clearMap();
                $('#routeInfo').html('<p style="color: #999; text-align: center; padding: 20px 0;">è¯·é€‰æ‹©ä¸€æ¡è·¯çº¿æŸ¥çœ‹è¯¦æƒ…</p>');
                $('#stationList').html('<p style="color: #999; text-align: center; padding: 20px 0;">åŠ è½½è·¯çº¿åæ˜¾ç¤ºç«™ç‚¹</p>');
                return;
            }

            $.ajax({
                url: baseURL + '/map/route/' + routeId,
                type: 'GET',
                success: function(res) {
                    if (res.code === 0) {
                        currentRoute = res.data;
                        displayRoute(res.data);
                    }
                }
            });
        }

        // æ˜¾ç¤ºè·¯çº¿
        function displayRoute(route) {
            clearMap();

            $('#routeInfo').html(`
                <p><strong>è·¯çº¿ç¼–å·:</strong> ${route.luxianbianhao}</p>
                <p><strong>è·¯çº¿åç§°:</strong> ${route.luxianmingcheng}</p>
                <p><strong>èµ·ç‚¹ç«™:</strong> ${route.qidianzhanming}</p>
                <p><strong>ç»ˆç‚¹ç«™:</strong> ${route.zhongdianzhanming}</p>
                <p><strong>ç¥¨ä»·:</strong> Â¥${route.jiage || 2}</p>
            `);

            $.ajax({
                url: baseURL + '/map/stations/' + route.id,
                type: 'GET',
                success: function(res) {
                    if (res.code === 0) {
                        try {
                            var stations = typeof res.data === 'string' ? JSON.parse(res.data) : res.data;
                            stationData = stations;
                            drawRoute(route, stations);
                            displayStationList(stations);
                        } catch (e) {
                            console.error('è§£æç«™ç‚¹æ•°æ®å¤±è´¥:', e);
                        }
                    }
                }
            });
        }

        // ç»˜åˆ¶è·¯çº¿
        function drawRoute(route, stations) {
            if (!stations || stations.length === 0) {
                return;
            }

            var latlngs = stations.map(function(s) {
                return [s.lat, s.lng];
            });

            var polyline = L.polyline(latlngs, {
                color: '#2196F3',
                weight: 5,
                opacity: 0.8
            }).addTo(routeLayer);

            stations.forEach(function(station, index) {
                var isTerminal = index === 0 || index === stations.length - 1;
                var marker = L.marker([station.lat, station.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: ' + (isTerminal ? '#4CAF50' : '#2196F3') + '; color: white; width: ' + (isTerminal ? '28' : '24') + 'px; height: ' + (isTerminal ? '28' : '24') + 'px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: ' + (isTerminal ? '13' : '11') + 'px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">' + (index + 1) + '</div>',
                        iconSize: [isTerminal ? 28 : 24, isTerminal ? 28 : 24],
                        iconAnchor: [isTerminal ? 14 : 12, isTerminal ? 14 : 12]
                    })
                }).addTo(markersLayer);

                marker.bindPopup('<div class="popup-content"><strong>' + station.name + '</strong><br>ç¬¬' + (index + 1) + 'ç«™</div>');

                marker.on('click', function() {
                    highlightStation(station.name);
                });
            });

            map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }

        // æ˜¾ç¤ºç«™ç‚¹åˆ—è¡¨
        function displayStationList(stations) {
            var html = '';
            stations.forEach(function(station, index) {
                html += '<div class="station-item" onclick="panToStation(' +
                        station.lat + ', ' + station.lng + ', \'' + station.name + '\', this)">';
                html += '<span class="station-index">' + (index + 1) + '</span>';
                html += '<span>' + station.name + '</span>';
                html += '</div>';
            });
            $('#stationList').html(html);
        }

        // å®šä½åˆ°ç«™ç‚¹
        function panToStation(lat, lng, name, element) {
            map.setView([lat, lng], 15);
            L.popup()
                .setLatLng([lat, lng])
                .setContent('<div class="popup-content"><strong>' + name + '</strong></div>')
                .openOn(map);

            $('.station-item').removeClass('active');
            $(element).addClass('active');
        }

        // é«˜äº®ç«™ç‚¹
        function highlightStation(name) {
            $('.station-item').each(function() {
                if ($(this).text().includes(name)) {
                    $(this).addClass('active');
                } else {
                    $(this).removeClass('active');
                }
            });
        }

        // é€‚åº”è§†å›¾
        function fitBounds() {
            if (routeLayer.getLayers().length > 0) {
                map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
            }
        }

        // æ¸…é™¤åœ°å›¾
        function clearMap() {
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            if (vehicleMarker) {
                map.removeLayer(vehicleMarker);
                vehicleMarker = null;
            }
            stopVehicle();
            stationData = [];
        }

        // åˆ‡æ¢è½¦è¾†æ¨¡æ‹Ÿ
        function toggleVehicle() {
            if (isVehicleRunning) {
                stopVehicle();
            } else {
                startVehicle();
            }
        }

        // å¼€å§‹è½¦è¾†æ¨¡æ‹Ÿ
        function startVehicle() {
            if (stationData.length < 2) {
                layui.layer.msg('è¯·å…ˆé€‰æ‹©ä¸€æ¡è·¯çº¿');
                return;
            }

            isVehicleRunning = true;
            vehicleIndex = 0;

            vehicleMarker = L.marker([stationData[0].lat, stationData[0].lng], {
                icon: L.divIcon({
                    className: 'vehicle-marker',
                    html: '<div style="background: #F44336; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ğŸšŒ</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map);

            vehicleMarker.bindPopup('<div class="popup-content"><strong>è½¦è¾†</strong><br>' + stationData[0].name + 'ç«™</div>').openPopup();

            vehicleTimer = setInterval(moveVehicle, 2000);

            $('#vehicleBtn').text('åœæ­¢æ¨¡æ‹Ÿ').removeClass('btn-secondary').addClass('btn-danger');
        }

        // ç§»åŠ¨è½¦è¾†
        function moveVehicle() {
            vehicleIndex++;
            if (vehicleIndex >= stationData.length) {
                vehicleIndex = 0;
            }

            var station = stationData[vehicleIndex];
            vehicleMarker.setLatLng([station.lat, station.lng]);

            vehicleMarker.setPopupContent('<div class="popup-content"><strong>è½¦è¾†</strong><br>' + station.name + 'ç«™</div>');

            if (vehicleIndex === stationData.length - 1) {
                setTimeout(function() {
                    if (isVehicleRunning) {
                        vehicleIndex = -1;
                    }
                }, 2000);
            }
        }

        // åœæ­¢è½¦è¾†æ¨¡æ‹Ÿ
        function stopVehicle() {
            isVehicleRunning = false;
            if (vehicleTimer) {
                clearInterval(vehicleTimer);
                vehicleTimer = null;
            }
            $('#vehicleBtn').text('æ¨¡æ‹Ÿè½¦è¾†').removeClass('btn-danger').addClass('btn-secondary');
        }

        $(document).ready(function() {
            initMap();
        });
    </script>
</body>
</html>
